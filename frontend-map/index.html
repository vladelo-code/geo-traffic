<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Moscow Traffic Map</title>

    <!-- MapLibre CSS -->
    <link
            href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
            rel="stylesheet"
    />

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* --- GLASS PANEL --- */
        .glass-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 60px);
            max-width: 800px;

            padding: 12px 20px;
            border-radius: 22px;

            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);

            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }

        /* --- BUTTON STYLE --- */
        .glass-btn {
            padding: 8px 14px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.35);
            color: #000;
            font-weight: 500;
            cursor: pointer;
            border: none;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: 0.2s;
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.55);
        }

        /* ZOOM BUTTONS */
        .zoom-box {
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(4px);
            cursor: pointer;
            font-size: 20px;
            border: none;
            transition: 0.2s;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.55);
        }
    </style>
</head>

<body>
<div id="map"></div>

<!-- Floating glass panel -->
<div class="glass-panel">
    <div class="panel-left">
        <!-- сюда можно поставить логотип <img src="logo.svg" height="28"/> -->
        <span class="project-title">GeoTraffic</span>
    </div>

    <div class="panel-center">
        <button class="glass-btn" id="refreshBtn">Обновить трафик</button>
    </div>

    <div class="zoom-box">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">−</button>
    </div>
</div>

<!-- MapLibre JS -->
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<script>
    const apiUrl = "http://localhost:8000/traffic";

    let map = new maplibregl.Map({
        container: 'map',
        style: "http://localhost:8081/styles/roads_style/style.json",
        center: [37.62, 55.75],
        zoom: 12
    });

    map.on('load', () => {
        map.addSource('traffic', {
            type: 'geojson',
            data: {type: 'FeatureCollection', features: []}
        });

        map.addLayer({
            id: 'traffic-lines',
            type: 'line',
            source: 'traffic',
            paint: {
                'line-width': [
                    'interpolate', ['linear'], ['zoom'],
                    8, 0.8,
                    12, 2,
                    15, 4
                ],
                'line-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'avg_speed'],
                    0, '#6d0606',
                    10, '#ff0000',
                    20, '#ff6600',
                    40, '#ffff00',
                    70, '#00cc00'
                ],
                'line-opacity': 0.9
            }
        });

        async function loadTraffic() {
            try {
                const resp = await fetch(apiUrl);
                const data = await resp.json();

                const features = data.map(item => ({
                    type: "Feature",
                    geometry: {
                        type: "LineString",
                        coordinates: item.polyline.map(p => [p[1], p[0]])
                    },
                    properties: {
                        edge_id: item.edge_id,
                        avg_speed: item.avg_speed,
                        cars_count: item.cars_count
                    }
                }));

                map.getSource('traffic').setData({
                    type: "FeatureCollection",
                    features
                });

            } catch (e) {
                console.error("Traffic load error:", e);
            }
        }

        loadTraffic();
        setInterval(loadTraffic, 10000);

        // --- UI HANDLERS ---
        document.getElementById("refreshBtn").onclick = loadTraffic;
        document.getElementById("zoomIn").onclick = () => map.zoomIn();
        document.getElementById("zoomOut").onclick = () => map.zoomOut();
    });
</script>

</body>
</html>